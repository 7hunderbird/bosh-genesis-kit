---
params:
  protobosh_network:
    range: (( param "Enter the CIDR for the proto-BOSH's subnet" ))
    gateway: (( param "Enter the gateway for the proto-BOSH's subnet" ))
    dns: (( param "Enter the DNS servers (list) for the proto-BOSH's subnet" ))
    static_ip: (( param "Enter the static IP for your proto-BOSH" ))
    subnet_id: (( param "Enter the AWS subnet ID for the proto-BOSH's subnet" ))
    security_groups: (( param "Enter the list of security groups to be applied to your proto-BOSH" ))
  aws:
    private_key: (( param "What private key file should be used for establishing the ssh_tunnel to BOSH during bosh-init?" ))

  protobosh_vm:
    instance_type: m3.xlarge
    disk_type: gp2
    ephemeral_disk: 25_000
    persistent_disk: 20_000
    availability_zone: (( param "Please specify the Availability Zone your proto-BOSH will live in" ))

vm_types:
- name: bosh
  cloud_properties:
    instance_type: (( grab params.protobosh_vm.instance_type ))
    ephemeral_disk:
      type: (( grab params.protobosh_vm.disk_type ))
      size: (( grab params.protobosh_vm.ephemeral_disk ))
    availability_zone: (( grab params.protobosh_vm.availability_zone ))
  env:
    bosh:
      password: (( grab meta.vcap_password ))

networks:
- name: bosh
  type: manual
  subnets:
  - range: (( grab params.protobosh_network.range ))
  gateway: (( grab params.protobosh_network.gateway ))
  dns: (( grab params.protobosh_network.dns ))
  static: [ (( grab params.protobosh_network.static_ip )) ]
  cloud_properties:
    security_groups: (( grab params.protobosh_network.security_groups ))
    subnet: (( grab params.protobosh_network.subnet_id ))

disk_pools:
- name: bosh
  disk_size: (( grab params.protobosh_vm.persistent_disk ))
  cloud_properties:
    type: (( grab params.protobosh_vm.disk_type ))


cloud_provider:
  mbus: (( concat "https://mbus:mbus-password@" instance_groups.bosh.networks[0].static_ips.0 ":6868" ))

  template:
    name: aws_cpi
    release: bosh-aws-cpi
  ssh_tunnel:
    port 22
  user: vcap
  host: (( grab instance_groups.bosh.networks[0].static_ips[0] ))
  private_key: (( grab params.aws.private_key ))

  properties:
    agent:
      mbus: https://mbus:mbus-password@0.0.0.0:6868
    blobstore:
      path: /var/vcap/micro_bosh/data/cache
      provider: local
    ntp: (( grab params.ntp ))
    aws: (( grab properties.aws )) 
